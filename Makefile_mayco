# Change these!
DESIGN_LIB = $(shell basename $(shell pwd))
USR = rusdac

SPICE_RUNS = q1b q2b q3a

EE476_HOME = /gscratch/ece/courses/476/${USR}
DESIGN_DIR = ${EE476_HOME}/cadence
NETLIST_DIR = ${EE476_HOME}/$(DESIGN_LIB)/spice/netlists
SCRIPTS_DIR = ${EE476_HOME}/scripts
# VPATH=touchfiles
XNETLIST = ${SCRIPTS_DIR}/xnetlist.py
SPICESETUP = ${SCRIPTS_DIR}/spiceSetup.py
GENERATEMEASTABLE = ${SCRIPTS_DIR}/generateMeasTable.py

all: $(foreach run,${SPICE_RUNS},spice/out/${run}.lis)

spice/netlists/%/hspiceD/schematic/netlist/input.ckt: ${DESIGN_DIR}/${DESIGN_LIB}/%/schematic/sch.oa
	@mkdir -p ${@D}
	rm -f $@
	cd ${DESIGN_DIR}; ${XNETLIST} -l ${DESIGN_LIB} -c $* -v schematic -d ${DESIGN_DIR} -n ${NETLIST_DIR} | virtuoso -64 -ocean
	test -f $@ # Need to fail the rule if netlist generation failed

spice/processed_netlists/%.ckt: spice/netlists/%/hspiceD/schematic/netlist/input.ckt ${SPICESETUP}
	@mkdir -p ${@D}
	${SPICESETUP} -i $< -o $@

spice/out/%.lis spice/out/%.mt0: %.ctl
	@mkdir -p ${@D}
	hspice $< -o $@

spice/meas/%_meas.tab: spice/out/%.mt0
	${GENERATEMEASTABLE} -i $< -o $@ -v r'*'

spice/out/q1b.lis: spice/processed_netlists/loaded_flip_flop.ckt
spice/out/q2b.lis: spice/pex_shims/loaded_flip_flop.ckt calibre/DFAR.pex.netlist
spice/out/q3a.lis: spice/pex_shims/loaded_flip_flop_r_c_cc.ckt calibre/DFAR_r_c_cc.pex.netlist

.SUFFIXES:
.PHONY: all
